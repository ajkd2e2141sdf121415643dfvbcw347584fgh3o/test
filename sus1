-- Services
local Players = game:GetService("Players")
local TeleportService = game:GetService("TeleportService")
local StarterGui = game:GetService("StarterGui")

local LocalPlayer = Players.LocalPlayer or Players.PlayerAdded:Wait()

-- ✅ ฟังก์ชันรอ Character ให้แน่นอน
local function getCharacter()
    if LocalPlayer.Character and LocalPlayer.Character.Parent then
        return LocalPlayer.Character
    end
    return LocalPlayer.CharacterAdded:Wait()
end

local function waitForHumanoid()
    local character = getCharacter()
    return character:WaitForChild("Humanoid")
end

-- เรียกครั้งแรก
local humanoid = waitForHumanoid()

-- ฟังก์ชันให้ GUI โหลด
local function getGuiObjects()
    local pg = LocalPlayer:WaitForChild("PlayerGui")
    local interface = pg:WaitForChild("Interface")
    local diamondCount = interface:WaitForChild("DiamondCount")
    local countLabel = diamondCount:WaitForChild("Count")
    return countLabel
end

local countLabel = getGuiObjects()

-- Config
--getgenv().LockDiamond = "2000"
getgenv().LockDiamondEnabled = true
--getgenv().SelectClass = "Campfire"
getgenv().BuyClassSelect = true

-- ฟังก์ชันแจ้งเตือน
local function notify(title, text, duration)
    pcall(function()
        StarterGui:SetCore("SendNotification", {
            Icon = "rbxassetid://16129235054",
            Title = title,
            Text = text,
            Duration = duration or 3
        })
    end)
end

-- ฟังก์ชันตรวจสอบ Place ID
local function isInLobby()
    return game.PlaceId == 79546208627805
end

-- ✅ handle respawn → เวลาตายแล้วเกิดใหม่ จะโหลด Humanoid + GUI ใหม่
LocalPlayer.CharacterAdded:Connect(function()
    humanoid = waitForHumanoid()
    countLabel = getGuiObjects()
    notify("Respawned", "Character and UI reloaded", 3)
end)

-- Loop หลัก
spawn(function()
    notify("Script Started", "FPS Booster and Diamond Manager is running...", 5)
    while task.wait(1) do
        if getgenv().LockDiamondEnabled and countLabel then
            local diamondValue = tonumber(countLabel.Text) or 0
            local targetValue = tonumber(getgenv().LockDiamond) or 0
            local className = getgenv().SelectClass or "None"

            notify("Checking Diamonds", "Current: " .. diamondValue .. " | Target: " .. targetValue, 2)
            notify("Class Target", "Selected Class: " .. className, 2)

            if diamondValue >= targetValue then
                notify("Diamond Target Reached", "Teleporting to Lobby...", 3)
                if not isInLobby() then
                    pcall(function()
                        TeleportService:Teleport(79546208627805, LocalPlayer)
                        notify("Teleporting", "Moving to Place ID 79546208627805", 3)
                    end)
                else
                    notify("Already in Lobby", "No teleport needed", 2)
                end
            else
                notify("Farming Diamonds", "Starting farm script (Value: " .. diamondValue .. ")", 3)
                getgenv().V = "Kaitundiamond"
                pcall(function()
                    loadstring(game:HttpGet("https://raw.githubusercontent.com/AAwful/Vector_Hub/0/v2"))()
                    notify("Farm Script Loaded", "Vector Hub script is running", 3)
                end)
            end
        elseif not countLabel then
            notify("Error", "DiamondCount not found, skipping loop...", 5)
        end
    end
end)
